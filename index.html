<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>99 Nights Math Forest ‚Äì Portal Lobby</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kalam:wght@300;400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-deep: #02040a;
      --bg-panel: #0c1420;
      --accent-fire: #ff7b00;
      --accent-fire-soft: #ffb347;
      --accent-ok: #7cd992;
      --text-main: #f6f3ea;
      --text-muted: #c4c4c4;
      --border-soft: rgba(255, 255, 255, 0.06);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #101529 0%, #02040a 60%);
      font-family: 'Kalam', cursive;
      color: var(--text-main);
      overflow: hidden;
    }

    .lobby-container {
      width: 100vw;
      height: 100vh;
      position: relative;
    }

    #lobbyCanvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    .lobby-title {
      position: absolute;
      top: 30px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 42px;
      font-weight: 700;
      color: var(--accent-fire);
      text-shadow: 0 0 20px rgba(255, 123, 0, 0.5), 0 4px 8px rgba(0,0,0,0.5);
      z-index: 10;
      pointer-events: none;
      text-align: center;
    }

    .lobby-subtitle {
      font-size: 18px;
      color: var(--text-muted);
      margin-top: 8px;
    }

    .portal-tooltip {
      position: absolute;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(12, 20, 32, 0.95);
      border: 2px solid var(--accent-fire);
      border-radius: 12px;
      padding: 16px 24px;
      z-index: 20;
      text-align: center;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .portal-tooltip.visible {
      opacity: 1;
    }

    .portal-tooltip-name {
      font-size: 24px;
      font-weight: 700;
      color: var(--accent-fire);
      margin-bottom: 8px;
    }

    .portal-tooltip-desc {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .portal-tooltip-action {
      font-size: 16px;
      color: var(--accent-ok);
    }

    .portal-tooltip.locked .portal-tooltip-name {
      color: #666;
    }

    .portal-tooltip.locked .portal-tooltip-action {
      color: #888;
    }

    .controls-hint {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 14px;
      color: var(--text-muted);
      z-index: 10;
      pointer-events: none;
    }

    .controls-hint kbd {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 4px;
      padding: 2px 8px;
      margin: 0 2px;
    }

    /* Crosshair for first-person view */
    .crosshair {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 10;
    }

    .crosshair::before,
    .crosshair::after {
      content: '';
      position: absolute;
      background: rgba(255, 255, 255, 0.7);
      box-shadow: 0 0 3px rgba(0,0,0,0.5);
    }

    .crosshair::before {
      width: 20px;
      height: 2px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .crosshair::after {
      width: 2px;
      height: 20px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    /* Admin Panel Styles */
    .admin-button {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #1a2a40 0%, #0c1420 100%);
      border: 2px solid var(--accent-fire);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 100;
      font-size: 24px;
      transition: all 0.2s ease;
      box-shadow: 0 4px 15px rgba(255, 123, 0, 0.3);
    }

    .admin-button:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(255, 123, 0, 0.5);
    }

    .admin-panel {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(2, 4, 10, 0.95);
      z-index: 1000;
      display: none;
      overflow-y: auto;
    }

    .admin-panel.active {
      display: block;
    }

    .admin-content {
      max-width: 900px;
      margin: 0 auto;
      padding: 30px;
    }

    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--border-soft);
    }

    .admin-title {
      font-size: 32px;
      font-weight: 700;
      color: var(--accent-fire);
    }

    .admin-close {
      width: 40px;
      height: 40px;
      background: rgba(255, 94, 94, 0.2);
      border: 2px solid #ff5e5e;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.2s ease;
    }

    .admin-close:hover {
      background: rgba(255, 94, 94, 0.4);
      transform: scale(1.1);
    }

    .admin-section {
      background: linear-gradient(180deg, #0c1420 0%, #060a16 100%);
      border: 1px solid var(--border-soft);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .admin-section-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--accent-fire-soft);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .mapping-row {
      display: grid;
      grid-template-columns: 180px 1fr 100px 120px;
      gap: 15px;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-soft);
    }

    .mapping-row:last-child {
      border-bottom: none;
    }

    .mapping-label {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-main);
    }

    .mapping-select {
      width: 100%;
      padding: 10px 12px;
      background: #1a2a40;
      border: 1px solid var(--border-soft);
      border-radius: 8px;
      color: var(--text-main);
      font-family: 'Kalam', cursive;
      font-size: 14px;
      cursor: pointer;
    }

    .mapping-select:focus {
      outline: none;
      border-color: var(--accent-fire);
    }

    .mapping-input {
      width: 100%;
      padding: 10px 12px;
      background: #1a2a40;
      border: 1px solid var(--border-soft);
      border-radius: 8px;
      color: var(--text-main);
      font-family: 'Kalam', cursive;
      font-size: 14px;
      text-align: center;
    }

    .mapping-input:focus {
      outline: none;
      border-color: var(--accent-fire);
    }

    .mapping-header {
      display: grid;
      grid-template-columns: 180px 1fr 100px 120px;
      gap: 15px;
      padding: 0 0 10px 0;
      border-bottom: 2px solid var(--accent-fire);
      margin-bottom: 5px;
    }

    .mapping-header-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
    }

    .admin-buttons {
      display: flex;
      gap: 15px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .admin-btn {
      padding: 12px 24px;
      border-radius: 8px;
      font-family: 'Kalam', cursive;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .admin-btn-save {
      background: linear-gradient(135deg, var(--accent-fire) 0%, #ff9500 100%);
      border: none;
      color: white;
    }

    .admin-btn-save:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(255, 123, 0, 0.5);
    }

    .admin-btn-reset {
      background: transparent;
      border: 2px solid var(--text-muted);
      color: var(--text-muted);
    }

    .admin-btn-reset:hover {
      border-color: #ff5e5e;
      color: #ff5e5e;
    }

    .save-notification {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, var(--accent-ok) 0%, #5cb978 100%);
      color: white;
      padding: 15px 30px;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      z-index: 2000;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .save-notification.visible {
      opacity: 1;
    }

    .problem-types-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .problem-type-card {
      background: #1a2a40;
      border: 1px solid var(--border-soft);
      border-radius: 8px;
      padding: 10px 12px;
    }

    .problem-type-id {
      font-size: 11px;
      color: var(--accent-fire);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .problem-type-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-main);
    }

    .problem-type-desc {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Class Shop Styles */
    .shop-button {
      position: absolute;
      top: 20px;
      right: 80px;
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #2a1a40 0%, #1a0c30 100%);
      border: 2px solid #a855f7;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 100;
      font-size: 24px;
      transition: all 0.2s ease;
      box-shadow: 0 4px 15px rgba(168, 85, 247, 0.3);
    }

    .shop-button:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(168, 85, 247, 0.5);
    }

    .stats-bar {
      position: absolute;
      top: 20px;
      left: 20px;
      display: flex;
      gap: 15px;
      z-index: 100;
    }

    .stat-display {
      background: linear-gradient(135deg, #1a2a40 0%, #0c1420 100%);
      border: 2px solid var(--border-soft);
      border-radius: 20px;
      padding: 8px 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 16px;
      font-weight: 600;
    }

    .stat-display.diamonds {
      border-color: #60d5f7;
      color: #60d5f7;
    }

    .stat-display.level {
      border-color: #ffd700;
      color: #ffd700;
    }

    .shop-panel {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(2, 4, 10, 0.95);
      z-index: 1000;
      display: none;
      overflow-y: auto;
    }

    .shop-panel.active {
      display: block;
    }

    .shop-content {
      max-width: 1000px;
      margin: 0 auto;
      padding: 30px;
    }

    .shop-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--border-soft);
    }

    .shop-title {
      font-size: 32px;
      font-weight: 700;
      color: #a855f7;
    }

    .shop-diamonds {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 24px;
      color: #60d5f7;
    }

    .shop-close {
      width: 40px;
      height: 40px;
      background: rgba(255, 94, 94, 0.2);
      border: 2px solid #ff5e5e;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.2s ease;
    }

    .shop-close:hover {
      background: rgba(255, 94, 94, 0.4);
      transform: scale(1.1);
    }

    .classes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .class-card {
      background: linear-gradient(180deg, #1a2a40 0%, #0c1420 100%);
      border: 2px solid var(--border-soft);
      border-radius: 16px;
      padding: 20px;
      transition: all 0.2s ease;
    }

    .class-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }

    .class-card.owned {
      border-color: var(--accent-ok);
      background: linear-gradient(180deg, #1a3020 0%, #0c200c 100%);
    }

    .class-card.locked {
      opacity: 0.5;
      border-color: #444;
    }

    .class-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .class-icon {
      font-size: 36px;
    }

    .class-cost {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 18px;
      font-weight: 700;
      color: #60d5f7;
    }

    .class-card.owned .class-cost {
      color: var(--accent-ok);
    }

    .class-name {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-main);
      margin-bottom: 8px;
    }

    .class-effect {
      font-size: 14px;
      color: var(--accent-fire-soft);
      margin-bottom: 12px;
    }

    .class-requirement {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .class-card.locked .class-requirement {
      color: #ff6b6b;
    }

    .class-buy-btn {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      font-family: 'Kalam', cursive;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      background: linear-gradient(135deg, #a855f7 0%, #8b5cf6 100%);
      border: none;
      color: white;
    }

    .class-buy-btn:hover:not(:disabled) {
      transform: scale(1.02);
      box-shadow: 0 4px 15px rgba(168, 85, 247, 0.5);
    }

    .class-buy-btn:disabled {
      background: #333;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .class-card.owned .class-buy-btn {
      background: var(--accent-ok);
      cursor: default;
    }

    .class-card.locked .class-buy-btn {
      background: #444;
    }

    .purchase-notification {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, #a855f7 0%, #8b5cf6 100%);
      color: white;
      padding: 30px 50px;
      border-radius: 16px;
      font-size: 24px;
      font-weight: 700;
      z-index: 2000;
      text-align: center;
      animation: purchasePop 0.5s ease-out;
    }

    @keyframes purchasePop {
      0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
      50% { transform: translate(-50%, -50%) scale(1.1); }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    /* Quest Board Styles */
    .quest-button {
      position: absolute;
      top: 20px;
      right: 140px;
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #1a402a 0%, #0c301a 100%);
      border: 2px solid #22c55e;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 100;
      font-size: 24px;
      transition: all 0.2s ease;
      box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
    }

    .quest-button:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(34, 197, 94, 0.5);
    }

    /* Daily Reward Button */
    .daily-reward-button {
      position: absolute;
      top: 20px;
      right: 320px;
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #3a2a1a 0%, #2a1a0c 100%);
      border: 2px solid #fbbf24;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 100;
      font-size: 24px;
      transition: all 0.2s ease;
      box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3);
    }

    .daily-reward-button:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(251, 191, 36, 0.5);
    }

    .daily-reward-button.has-reward {
      animation: rewardPulse 2s ease-in-out infinite;
    }

    @keyframes rewardPulse {
      0%, 100% { box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3); }
      50% { box-shadow: 0 4px 25px rgba(251, 191, 36, 0.7); }
    }

    /* Pet Button */
    .pet-button {
      position: absolute;
      top: 20px;
      right: 260px;
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #2a3a1a 0%, #1a2a0c 100%);
      border: 2px solid #84cc16;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 100;
      font-size: 24px;
      transition: all 0.2s ease;
      box-shadow: 0 4px 15px rgba(132, 204, 22, 0.3);
    }

    .pet-button:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(132, 204, 22, 0.5);
    }

    .pet-button.no-pet {
      opacity: 0.5;
    }

    /* Pet Panel */
    .pet-panel {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(2, 4, 10, 0.95);
      z-index: 1000;
      display: none;
      overflow-y: auto;
    }

    .pet-panel.active {
      display: block;
    }

    .pet-content {
      max-width: 600px;
      margin: 0 auto;
      padding: 30px;
    }

    .pet-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--border-soft);
    }

    .pet-header-title {
      font-size: 32px;
      font-weight: 700;
      color: #84cc16;
    }

    .pet-close {
      width: 40px;
      height: 40px;
      background: rgba(255, 94, 94, 0.2);
      border: 2px solid #ff5e5e;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.2s ease;
    }

    .pet-close:hover {
      background: rgba(255, 94, 94, 0.4);
      transform: scale(1.1);
    }

    .pet-card-large {
      background: linear-gradient(135deg, #1a2332 0%, #0c1420 100%);
      border: 2px solid #84cc16;
      border-radius: 16px;
      padding: 30px;
      text-align: center;
      margin-bottom: 20px;
    }

    .pet-card-icon-large {
      font-size: 100px;
      margin-bottom: 15px;
      animation: petFloat 2s ease-in-out infinite;
    }

    @keyframes petFloat {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .pet-card-name-large {
      font-size: 36px;
      font-weight: 700;
      color: var(--text-main);
      margin-bottom: 10px;
    }

    .pet-card-type {
      font-size: 18px;
      color: #84cc16;
      margin-bottom: 20px;
    }

    .pet-happiness-section {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .pet-happiness-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 16px;
    }

    .pet-happiness-bar-large {
      height: 16px;
      background: var(--bg-deep);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .pet-happiness-fill-large {
      height: 100%;
      background: linear-gradient(90deg, #22c55e 0%, #4ade80 100%);
      border-radius: 8px;
      transition: width 0.3s ease;
    }

    .pet-happiness-fill-large.hungry {
      background: linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%);
    }

    .pet-happiness-fill-large.very-hungry {
      background: linear-gradient(90deg, #ff5e5e 0%, #ff8080 100%);
    }

    .pet-abilities-section {
      background: rgba(132, 204, 22, 0.1);
      border: 1px solid rgba(132, 204, 22, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .pet-abilities-title {
      font-size: 18px;
      font-weight: 700;
      color: #84cc16;
      margin-bottom: 15px;
    }

    .pet-ability-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .pet-ability-item:last-child {
      margin-bottom: 0;
    }

    .pet-ability-active {
      color: #22c55e;
      font-weight: 600;
    }

    .pet-ability-inactive {
      color: #ff5e5e;
      opacity: 0.7;
    }

    .pet-stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .pet-stat-item {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      padding: 15px;
      text-align: center;
    }

    .pet-stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--accent-fire);
    }

    .pet-stat-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 5px;
    }

    .pet-feed-section {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      padding: 20px;
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 12px;
    }

    .pet-feed-btn-large {
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      border: none;
      color: white;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 18px;
      font-weight: 700;
      font-family: 'Kalam', cursive;
      cursor: pointer;
      transition: all 0.2s;
    }

    .pet-feed-btn-large:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
    }

    .no-pet-message {
      text-align: center;
      padding: 60px 30px;
      color: var(--text-muted);
    }

    .no-pet-icon {
      font-size: 80px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .no-pet-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-main);
      margin-bottom: 15px;
    }

    .no-pet-desc {
      font-size: 16px;
      line-height: 1.6;
    }

    /* Achievement Gallery Button */
    .achievement-button {
      position: absolute;
      top: 20px;
      right: 200px;
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #402a1a 0%, #301a0c 100%);
      border: 2px solid #f59e0b;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 100;
      font-size: 24px;
      transition: all 0.2s ease;
      box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
    }

    .achievement-button:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(245, 158, 11, 0.5);
    }

    /* Achievement Gallery Panel */
    .achievement-panel {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(2, 4, 10, 0.95);
      z-index: 1000;
      display: none;
      overflow-y: auto;
    }

    .achievement-panel.active {
      display: block;
    }

    .achievement-content {
      max-width: 900px;
      margin: 0 auto;
      padding: 30px;
    }

    .achievement-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--border-soft);
    }

    .achievement-header-title {
      font-size: 32px;
      font-weight: 700;
      color: #f59e0b;
    }

    .achievement-header-stats {
      display: flex;
      gap: 20px;
      align-items: center;
    }

    .achievement-stat {
      text-align: center;
    }

    .achievement-stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--accent-fire);
    }

    .achievement-stat-label {
      font-size: 12px;
      color: var(--text-muted);
    }

    .achievement-close {
      width: 40px;
      height: 40px;
      background: rgba(255, 94, 94, 0.2);
      border: 2px solid #ff5e5e;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.2s ease;
    }

    .achievement-close:hover {
      background: rgba(255, 94, 94, 0.4);
      transform: scale(1.1);
    }

    .achievement-category {
      margin-bottom: 30px;
    }

    .achievement-category-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-left: 12px;
      border-left: 4px solid #f59e0b;
    }

    .achievement-category-name {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-main);
    }

    .achievement-category-count {
      font-size: 14px;
      color: var(--text-muted);
    }

    .achievement-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 15px;
    }

    .achievement-card {
      background: linear-gradient(135deg, #1a2332 0%, #0c1420 100%);
      border: 2px solid var(--border-soft);
      border-radius: 12px;
      padding: 16px;
      display: flex;
      gap: 14px;
      transition: all 0.2s ease;
    }

    .achievement-card.earned {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.2) 0%, rgba(245, 158, 11, 0.05) 100%);
      border-color: #f59e0b;
    }

    .achievement-card.locked {
      opacity: 0.5;
    }

    .achievement-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    }

    .achievement-card-icon {
      font-size: 40px;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-panel);
      border-radius: 10px;
      flex-shrink: 0;
    }

    .achievement-card.earned .achievement-card-icon {
      background: rgba(245, 158, 11, 0.3);
    }

    .achievement-card-info {
      flex: 1;
      min-width: 0;
    }

    .achievement-card-name {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-main);
      margin-bottom: 4px;
    }

    .achievement-card-desc {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .achievement-card-progress {
      height: 8px;
      background: var(--bg-deep);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 6px;
    }

    .achievement-card-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .achievement-card-status {
      font-size: 12px;
      color: var(--text-muted);
    }

    .achievement-card.earned .achievement-card-status {
      color: #22c55e;
      font-weight: 600;
    }

    .achievement-card-reward {
      font-size: 14px;
      color: #fbbf24;
      font-weight: 600;
      margin-top: 4px;
    }

    .quest-panel {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(2, 4, 10, 0.95);
      z-index: 1000;
      display: none;
      overflow-y: auto;
    }

    .quest-panel.active {
      display: block;
    }

    .quest-content {
      max-width: 800px;
      margin: 0 auto;
      padding: 30px;
    }

    .quest-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--border-soft);
    }

    .quest-title {
      font-size: 32px;
      font-weight: 700;
      color: #22c55e;
    }

    .quest-close {
      width: 40px;
      height: 40px;
      background: rgba(255, 94, 94, 0.2);
      border: 2px solid #ff5e5e;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.2s ease;
    }

    .quest-close:hover {
      background: rgba(255, 94, 94, 0.4);
      transform: scale(1.1);
    }

    .quest-refresh-info {
      text-align: center;
      color: var(--text-muted);
      margin-bottom: 20px;
    }

    .quests-grid {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .quest-card {
      background: linear-gradient(180deg, #1a2a40 0%, #0c1420 100%);
      border: 2px solid var(--border-soft);
      border-radius: 16px;
      padding: 20px;
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 20px;
      align-items: center;
      transition: all 0.2s ease;
    }

    .quest-card:hover {
      transform: translateX(4px);
      border-color: #22c55e;
    }

    .quest-card.completed {
      border-color: var(--accent-ok);
      background: linear-gradient(180deg, #1a3020 0%, #0c200c 100%);
      opacity: 0.8;
    }

    .quest-icon {
      font-size: 40px;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(34, 197, 94, 0.1);
      border-radius: 12px;
    }

    .quest-info {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .quest-name {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-main);
    }

    .quest-progress-bar {
      height: 8px;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 4px;
      overflow: hidden;
    }

    .quest-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #22c55e 0%, #4ade80 100%);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .quest-progress-text {
      font-size: 12px;
      color: var(--text-muted);
    }

    .quest-reward {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }

    .quest-reward-amount {
      font-size: 24px;
      font-weight: 700;
      color: #60d5f7;
    }

    .quest-reward-label {
      font-size: 12px;
      color: var(--text-muted);
    }

    .quest-card.completed .quest-reward-amount {
      color: var(--accent-ok);
    }

    .no-quests {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }

    .refresh-quests-btn {
      display: block;
      margin: 20px auto 0;
      padding: 12px 30px;
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      border: none;
      border-radius: 8px;
      color: white;
      font-family: 'Kalam', cursive;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .refresh-quests-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(34, 197, 94, 0.5);
    }

    .refresh-quests-btn:disabled {
      background: #333;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="lobby-container">
    <canvas id="lobbyCanvas"></canvas>
    
    <div class="lobby-title">
      üî• 99 Nights üî•
      <div class="lobby-subtitle">Choose Your Challenge</div>
    </div>
    
    <div class="crosshair"></div>
    
    <div id="portalTooltip" class="portal-tooltip">
      <div class="portal-tooltip-name" id="tooltipName">Adding</div>
      <div class="portal-tooltip-desc" id="tooltipDesc">Practice addition problems</div>
      <div class="portal-tooltip-action" id="tooltipAction">Press ENTER or CLICK to enter</div>
    </div>
    
    <div class="controls-hint">
      <kbd>‚Üë</kbd><kbd>‚Üì</kbd><kbd>‚Üê</kbd><kbd>‚Üí</kbd> or <kbd>W</kbd><kbd>A</kbd><kbd>S</kbd><kbd>D</kbd> to move ‚Ä¢ Mouse to look ‚Ä¢ Walk through a portal to enter!
    </div>

    <!-- Stats Bar -->
    <div class="stats-bar">
      <div class="stat-display diamonds">
        üíé <span id="diamondCount">0</span>
      </div>
      <div class="stat-display level">
        ‚≠ê Level <span id="playerLevel">1</span>
      </div>
    </div>

    <!-- Daily Reward Button -->
    <div class="daily-reward-button" id="dailyRewardButton" title="Daily Rewards">üéÅ</div>

    <!-- Pet Button -->
    <div class="pet-button" id="petButton" title="Your Pet">üêæ</div>

    <!-- Achievement Button -->
    <div class="achievement-button" id="achievementButton" title="Achievements">üèÜ</div>

    <!-- Quest Button -->
    <div class="quest-button" id="questButton" title="Daily Quests">üìã</div>

    <!-- Shop Button -->
    <div class="shop-button" id="shopButton" title="Class Shop">üè™</div>

    <!-- Admin Button -->
    <div class="admin-button" id="adminButton" title="Math Settings">‚öôÔ∏è</div>

    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
      <div class="admin-content">
        <div class="admin-header">
          <div class="admin-title">‚öôÔ∏è Math Settings</div>
          <div class="admin-close" id="adminClose">‚úï</div>
        </div>

        <div class="admin-section">
          <div class="admin-section-title">üìù Problem Mappings</div>
          <p style="color: var(--text-muted); margin-bottom: 15px; font-size: 14px;">
            Choose which math problems appear for each game action
          </p>
          
          <div class="mapping-header">
            <div class="mapping-header-label">Action</div>
            <div class="mapping-header-label">Problem Type</div>
            <div class="mapping-header-label">Questions</div>
            <div class="mapping-header-label">Timer (sec)</div>
          </div>

          <div id="mappingsContainer">
            <!-- Mappings will be inserted here by JavaScript -->
          </div>
        </div>

        <div class="admin-section">
          <div class="admin-section-title">üìö Problem Types Reference</div>
          <div class="problem-types-grid" id="problemTypesGrid">
            <!-- Problem types will be inserted here by JavaScript -->
          </div>
        </div>

        <div class="admin-buttons">
          <button class="admin-btn admin-btn-reset" id="resetMappingsBtn">Reset to Defaults</button>
          <button class="admin-btn admin-btn-save" id="saveMappingsBtn">üíæ Save Settings</button>
        </div>
      </div>
    </div>

    <div class="save-notification" id="saveNotification">‚úì Settings Saved!</div>

    <!-- Shop Panel -->
    <div class="shop-panel" id="shopPanel">
      <div class="shop-content">
        <div class="shop-header">
          <div class="shop-title">üè™ Class Shop</div>
          <div class="shop-diamonds">üíé <span id="shopDiamondCount">0</span></div>
          <div class="shop-close" id="shopClose">‚úï</div>
        </div>

        <p style="color: var(--text-muted); margin-bottom: 20px;">
          Spend your diamonds on permanent upgrades that persist across games!
        </p>

        <div class="classes-grid" id="classesGrid">
          <!-- Classes will be inserted here by JavaScript -->
        </div>
      </div>
    </div>

    <!-- Pet Panel -->
    <div class="pet-panel" id="petPanel">
      <div class="pet-content">
        <div class="pet-header">
          <div class="pet-header-title">üêæ Your Pet</div>
          <div class="pet-close" id="petClose">‚úï</div>
        </div>
        
        <div id="petPanelContent">
          <!-- Will be populated by JavaScript -->
        </div>
      </div>
    </div>

    <!-- Achievement Panel -->
    <div class="achievement-panel" id="achievementPanel">
      <div class="achievement-content">
        <div class="achievement-header">
          <div class="achievement-header-title">üèÜ Achievements</div>
          <div class="achievement-header-stats">
            <div class="achievement-stat">
              <div class="achievement-stat-value" id="achievementEarnedCount">0</div>
              <div class="achievement-stat-label">Earned</div>
            </div>
            <div class="achievement-stat">
              <div class="achievement-stat-value" id="achievementTotalCount">0</div>
              <div class="achievement-stat-label">Total</div>
            </div>
            <div class="achievement-stat">
              <div class="achievement-stat-value" id="achievementDiamonds">0üíé</div>
              <div class="achievement-stat-label">Rewards Earned</div>
            </div>
          </div>
          <div class="achievement-close" id="achievementClose">‚úï</div>
        </div>
        
        <div id="achievementGallery">
          <!-- Achievements will be populated by JavaScript -->
        </div>
      </div>
    </div>

    <!-- Quest Panel -->
    <div class="quest-panel" id="questPanel">
      <div class="quest-content">
        <div class="quest-header">
          <div class="quest-title">üìã Daily Quests</div>
          <div class="quest-close" id="questClose">‚úï</div>
        </div>

        <div class="quest-refresh-info" id="questRefreshInfo">
          Quests refresh daily. Complete quests to earn diamonds!
        </div>

        <div class="quests-grid" id="questsGrid">
          <!-- Quests will be inserted here by JavaScript -->
        </div>

        <button class="refresh-quests-btn" id="refreshQuestsBtn">üé∞ Spin for New Quests</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script>
    // ============================================
    // PORTAL CONFIGURATION
    // ============================================
    
    // All portals in a single line so you can see more are coming!
    const PORTALS = [
      { 
        id: 'addition', 
        name: '‚ûï Adding', 
        description: 'Addition problems from easy to challenging',
        locked: false,
        position: { x: -50, z: -20 }
      },
      { 
        id: 'subtraction', 
        name: '‚ûñ Subtracting', 
        description: 'Subtraction problems to sharpen your skills',
        locked: false,
        position: { x: -30, z: -20 }
      },
      { 
        id: 'advanced_add_sub', 
        name: '‚ûï‚ûñ Advanced +‚àí', 
        description: 'Challenging addition and subtraction',
        locked: true,
        position: { x: -10, z: -20 }
      },
      { 
        id: 'multiplication', 
        name: '‚úñÔ∏è Multiplying', 
        description: 'Multiplication tables and beyond',
        locked: true,
        position: { x: 10, z: -20 }
      },
      { 
        id: 'division', 
        name: '‚ûó Dividing', 
        description: 'Division problems and remainders',
        locked: true,
        position: { x: 30, z: -20 }
      },
      { 
        id: 'advanced_mul_div', 
        name: '‚úñÔ∏è‚ûó Advanced √ó√∑', 
        description: 'Master-level multiplication and division',
        locked: true,
        position: { x: 50, z: -20 }
      }
    ];

    // ============================================
    // THREE.JS SETUP
    // ============================================
    
    const canvas = document.getElementById('lobbyCanvas');
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0a1628);
    scene.fog = new THREE.Fog(0x0a1628, 30, 80);
    
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 200);
    camera.position.set(0, 2, 15);
    
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    
    // Lighting
    const ambientLight = new THREE.AmbientLight(0x334466, 0.4);
    scene.add(ambientLight);
    
    const moonLight = new THREE.DirectionalLight(0x8899bb, 0.3);
    moonLight.position.set(10, 20, 10);
    scene.add(moonLight);

    // ============================================
    // VOXEL HELPERS (matching game style)
    // ============================================
    
    function createVoxelBox(width, height, depth, color) {
      const geometry = new THREE.BoxGeometry(width, height, depth);
      const material = new THREE.MeshLambertMaterial({ color });
      return new THREE.Mesh(geometry, material);
    }

    // ============================================
    // GROUND
    // ============================================
    
    function createGround() {
      const size = 100;
      const geometry = new THREE.PlaneGeometry(size, size);
      
      // Create grass texture like the game
      const canvas = document.createElement('canvas');
      canvas.width = 64;
      canvas.height = 64;
      const ctx = canvas.getContext('2d');
      
      ctx.fillStyle = '#1a3d1a';
      ctx.fillRect(0, 0, 64, 64);
      
      // Add grass details
      for (let i = 0; i < 100; i++) {
        const x = Math.random() * 64;
        const y = Math.random() * 64;
        ctx.fillStyle = Math.random() > 0.5 ? '#2a5a2a' : '#0f2f0f';
        ctx.fillRect(x, y, 2, 2);
      }
      
      const texture = new THREE.CanvasTexture(canvas);
      texture.wrapS = THREE.RepeatWrapping;
      texture.wrapT = THREE.RepeatWrapping;
      texture.repeat.set(25, 25);
      
      const material = new THREE.MeshLambertMaterial({ map: texture });
      const ground = new THREE.Mesh(geometry, material);
      ground.rotation.x = -Math.PI / 2;
      ground.position.y = 0;
      
      return ground;
    }

    // ============================================
    // TREES (background decoration)
    // ============================================
    
    function createTree(x, z) {
      const group = new THREE.Group();
      
      // Trunk
      const trunk = createVoxelBox(1, 4, 1, 0x4a3728);
      trunk.position.y = 2;
      group.add(trunk);
      
      // Foliage layers
      const foliageColors = [0x2d5a2d, 0x1e4a1e, 0x3d6a3d];
      const foliageSizes = [
        { w: 5, h: 2, d: 5, y: 5 },
        { w: 4, h: 2, d: 4, y: 7 },
        { w: 2, h: 2, d: 2, y: 9 }
      ];
      
      foliageSizes.forEach((size, i) => {
        const foliage = createVoxelBox(size.w, size.h, size.d, foliageColors[i % 3]);
        foliage.position.y = size.y;
        group.add(foliage);
      });
      
      group.position.set(x, 0, z);
      return group;
    }

    // ============================================
    // PORTAL CREATION
    // ============================================
    
    function createPortal(portalData) {
      const group = new THREE.Group();
      group.userData = { portal: portalData };
      
      const isLocked = portalData.locked;
      
      // Portal frame (stone archway)
      const frameColor = isLocked ? 0x333333 : 0x5a4a3a;
      const glowColor = isLocked ? 0x222222 : 0xff7b00;
      
      // Left pillar
      const leftPillar = createVoxelBox(2, 10, 2, frameColor);
      leftPillar.position.set(-4, 5, 0);
      group.add(leftPillar);
      
      // Right pillar
      const rightPillar = createVoxelBox(2, 10, 2, frameColor);
      rightPillar.position.set(4, 5, 0);
      group.add(rightPillar);
      
      // Top arch
      const topArch = createVoxelBox(10, 2, 2, frameColor);
      topArch.position.set(0, 10, 0);
      group.add(topArch);
      
      // Portal glow surface
      const portalGeometry = new THREE.PlaneGeometry(6, 8);
      
      if (!isLocked) {
        // Glowing portal effect
        const portalMaterial = new THREE.MeshBasicMaterial({ 
          color: glowColor,
          transparent: true,
          opacity: 0.6,
          side: THREE.DoubleSide
        });
        const portalSurface = new THREE.Mesh(portalGeometry, portalMaterial);
        portalSurface.position.set(0, 5, 0);
        portalSurface.userData.isPortalSurface = true;
        group.add(portalSurface);
        
        // Add point light for glow
        const portalLight = new THREE.PointLight(glowColor, 1, 15);
        portalLight.position.set(0, 5, 2);
        group.add(portalLight);
      } else {
        // Locked portal - chains/bars
        const barColor = 0x444444;
        for (let i = 0; i < 4; i++) {
          const bar = createVoxelBox(0.3, 8, 0.3, barColor);
          bar.position.set(-2 + i * 1.5, 5, 0);
          group.add(bar);
        }
        
        // Lock icon (simple representation)
        const lock = createVoxelBox(2, 2, 1, 0x666666);
        lock.position.set(0, 3, 0.5);
        group.add(lock);
      }
      
      // Sign with portal name
      const signGeometry = new THREE.PlaneGeometry(8, 2);
      const signCanvas = document.createElement('canvas');
      signCanvas.width = 256;
      signCanvas.height = 64;
      const signCtx = signCanvas.getContext('2d');
      
      signCtx.fillStyle = isLocked ? '#222' : '#1a0a00';
      signCtx.fillRect(0, 0, 256, 64);
      
      signCtx.font = 'bold 28px Kalam, cursive';
      signCtx.textAlign = 'center';
      signCtx.fillStyle = isLocked ? '#666' : '#ffb347';
      signCtx.fillText(portalData.name, 128, 42);
      
      const signTexture = new THREE.CanvasTexture(signCanvas);
      const signMaterial = new THREE.MeshBasicMaterial({ map: signTexture, transparent: true });
      const sign = new THREE.Mesh(signGeometry, signMaterial);
      sign.position.set(0, 12, 0);
      group.add(sign);
      
      group.position.set(portalData.position.x, 0, portalData.position.z);
      
      return group;
    }

    // ============================================
    // SCENE SETUP
    // ============================================
    
    // Add ground
    scene.add(createGround());
    
    // Add trees for atmosphere
    const treePositions = [
      [-40, -30], [-35, -15], [-45, 5], [-38, 20],
      [40, -30], [35, -15], [45, 5], [38, 20],
      [-20, -40], [0, -45], [20, -40],
      [-25, 30], [0, 35], [25, 30]
    ];
    
    treePositions.forEach(([x, z]) => {
      scene.add(createTree(x, z));
    });
    
    // Create portals
    const portalMeshes = [];
    PORTALS.forEach(portalData => {
      const portal = createPortal(portalData);
      scene.add(portal);
      portalMeshes.push(portal);
    });
    
    // Add central campfire for ambiance
    function createCampfire() {
      const group = new THREE.Group();
      
      // Logs
      const logColor = 0x4a3728;
      for (let i = 0; i < 4; i++) {
        const log = createVoxelBox(0.4, 0.4, 2, logColor);
        log.rotation.y = (i / 4) * Math.PI;
        log.position.y = 0.2;
        group.add(log);
      }
      
      // Fire glow
      const fireLight = new THREE.PointLight(0xff6600, 2, 20);
      fireLight.position.y = 1;
      group.add(fireLight);
      
      // Simple flame shapes
      const flameColors = [0xff4400, 0xff6600, 0xffaa00];
      for (let i = 0; i < 5; i++) {
        const flame = createVoxelBox(0.3, 1 + Math.random(), 0.3, flameColors[i % 3]);
        flame.position.set((Math.random() - 0.5) * 0.8, 0.5 + Math.random() * 0.5, (Math.random() - 0.5) * 0.8);
        flame.userData.isFlame = true;
        flame.userData.baseY = flame.position.y;
        group.add(flame);
      }
      
      return group;
    }
    
    const campfire = createCampfire();
    campfire.position.set(0, 0, 5);
    scene.add(campfire);

    // ============================================
    // PLAYER CONTROLS
    // ============================================
    
    let playerX = 0;
    let playerZ = 12;
    let yaw = 0;
    let pitch = 0;
    const playerSpeed = 0.15;
    
    const keys = {};
    
    document.addEventListener('keydown', (e) => {
      keys[e.key.toLowerCase()] = true;
      // Also track arrow keys
      keys[e.key] = true;
    });
    
    document.addEventListener('keyup', (e) => {
      keys[e.key.toLowerCase()] = false;
      keys[e.key] = false;
    });
    
    // Mouse look
    let isPointerLocked = false;
    
    canvas.addEventListener('click', () => {
      if (!isPointerLocked) {
        canvas.requestPointerLock();
      }
    });
    
    document.addEventListener('pointerlockchange', () => {
      isPointerLocked = document.pointerLockElement === canvas;
    });
    
    document.addEventListener('mousemove', (e) => {
      if (!isPointerLocked) return;
      
      const sensitivity = 0.002;
      yaw -= e.movementX * sensitivity;
      pitch -= e.movementY * sensitivity;
      pitch = Math.max(-Math.PI / 2 + 0.1, Math.min(Math.PI / 2 - 0.1, pitch));
    });

    // ============================================
    // PORTAL DETECTION
    // ============================================
    
    let nearbyPortal = null;
    const tooltip = document.getElementById('portalTooltip');
    const tooltipName = document.getElementById('tooltipName');
    const tooltipDesc = document.getElementById('tooltipDesc');
    const tooltipAction = document.getElementById('tooltipAction');
    
    let hasEnteredPortal = false; // Prevent double-entry
    
    function checkPortalProximity() {
      const detectionRange = 8;
      const enterRange = 3; // Auto-enter when this close
      let closest = null;
      let closestDist = Infinity;
      
      portalMeshes.forEach(portalMesh => {
        const dx = playerX - portalMesh.position.x;
        const dz = playerZ - portalMesh.position.z;
        const dist = Math.sqrt(dx * dx + dz * dz);
        
        if (dist < detectionRange && dist < closestDist) {
          closest = portalMesh;
          closestDist = dist;
        }
      });
      
      nearbyPortal = closest;
      
      if (nearbyPortal) {
        const portal = nearbyPortal.userData.portal;
        tooltipName.textContent = portal.name;
        tooltipDesc.textContent = portal.description;
        
        if (portal.locked) {
          tooltipAction.textContent = 'üîí Coming Soon!';
          tooltip.classList.add('locked');
        } else {
          tooltipAction.textContent = '‚ñ∂ Walk through to enter!';
          tooltip.classList.remove('locked');
          
          // Auto-enter when walking through the portal
          if (closestDist < enterRange && !hasEnteredPortal) {
            hasEnteredPortal = true;
            enterPortal(portal);
          }
        }
        
        tooltip.classList.add('visible');
      } else {
        tooltip.classList.remove('visible');
      }
    }

    // ============================================
    // ENTER PORTAL
    // ============================================
    
    function enterPortal(portal) {
      // Navigate to game with mode parameter
      window.location.href = `game.html?mode=${portal.id}`;
    }

    // ============================================
    // ANIMATION LOOP
    // ============================================
    
    function animate() {
      requestAnimationFrame(animate);
      
      // Movement (WASD and Arrow keys)
      const moveX = Math.sin(yaw);
      const moveZ = Math.cos(yaw);
      
      if (keys.w || keys.ArrowUp) {
        playerX -= moveX * playerSpeed;
        playerZ -= moveZ * playerSpeed;
      }
      if (keys.s || keys.ArrowDown) {
        playerX += moveX * playerSpeed;
        playerZ += moveZ * playerSpeed;
      }
      if (keys.a || keys.ArrowLeft) {
        playerX -= moveZ * playerSpeed;
        playerZ += moveX * playerSpeed;
      }
      if (keys.d || keys.ArrowRight) {
        playerX += moveZ * playerSpeed;
        playerZ -= moveX * playerSpeed;
      }
      
      // Clamp to world
      playerX = Math.max(-60, Math.min(60, playerX));
      playerZ = Math.max(-40, Math.min(30, playerZ));
      
      // Update camera
      camera.position.set(playerX, 2, playerZ);
      
      const lookX = playerX - Math.sin(yaw) * Math.cos(pitch);
      const lookY = 2 + Math.sin(pitch);
      const lookZ = playerZ - Math.cos(yaw) * Math.cos(pitch);
      camera.lookAt(lookX, lookY, lookZ);
      
      // Check portal proximity
      checkPortalProximity();
      
      // Animate flames
      scene.traverse(obj => {
        if (obj.userData.isFlame) {
          obj.position.y = obj.userData.baseY + Math.sin(Date.now() * 0.01 + obj.id) * 0.1;
          obj.scale.y = 0.8 + Math.sin(Date.now() * 0.015 + obj.id) * 0.3;
        }
      });
      
      // Animate portal glow
      portalMeshes.forEach(portal => {
        portal.traverse(child => {
          if (child.userData.isPortalSurface) {
            child.material.opacity = 0.4 + Math.sin(Date.now() * 0.003) * 0.2;
          }
        });
      });
      
      renderer.render(scene, camera);
    }
    
    // Handle window resize
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
    
    animate();

    // ============================================
    // ADMIN PANEL - PERSISTENCE & CONFIG
    // ============================================

    const SAVE_KEY = '99nights_save_v1';

    // Game actions that can be configured
    const GAME_ACTIONS = [
      { id: 'fightWolf', name: 'üê∫ Fight Wolf', defaultTimer: 7 },
      { id: 'fightCultist', name: 'üë§ Fight Cultist', defaultTimer: 7 },
      { id: 'chop', name: 'üå≤ Chop Tree', defaultTimer: 0 },
      { id: 'collectFuel', name: '‚õΩ Collect Fuel', defaultTimer: 0 },
      { id: 'salvageFan', name: 'üîß Salvage Fan', defaultTimer: 0 },
      { id: 'salvageBolt', name: 'üî© Salvage Bolt', defaultTimer: 0 },
      { id: 'salvageRadio', name: 'üìª Salvage Radio', defaultTimer: 0 },
      { id: 'collectKey', name: 'üîë Collect Key', defaultTimer: 0 },
      { id: 'crafting', name: 'üî® Crafting', defaultTimer: 0 },
      { id: 'harvestFarm', name: 'ü•ï Harvest Farm', defaultTimer: 0 },
      { id: 'makeStew', name: 'üç≤ Make Stew', defaultTimer: 0 },
    ];

    // Problem types available
    const PROBLEM_TYPES = [
      // Addition
      { id: 'add_level1', name: 'Easy Addition', desc: 'Adding 0-5' },
      { id: 'add_level2', name: 'Bridging Numbers', desc: 'Adding 0-5 and 9,10' },
      { id: 'add_level3', name: 'Medium Addition', desc: 'Adding 4-10' },
      { id: 'add_level4', name: 'Missing Addend', desc: '? + b = c' },
      { id: 'add_level5', name: 'Equation Balance', desc: 'a + b = c + ?' },
      { id: 'add_level6', name: 'Triple Addition', desc: 'a + b + c' },
      { id: 'add_level7', name: 'Triple Missing', desc: 'a + b + ? = d' },
      { id: 'add_level8', name: 'Tens Plus Ones', desc: '70 + 3' },
      { id: 'add_level9', name: 'Adding Ten', desc: 'Two-digit + 10' },
      { id: 'add_level10', name: 'Make Ten Triple', desc: '8 + 1 + 2' },
      { id: 'add_level11', name: 'Complement to 20', desc: 'a + ? = 20' },
      { id: 'add_level12', name: 'Two-Digit Plus One', desc: '45 + 7' },
      // Subtraction
      { id: 'subtract_level1', name: 'Basic Subtraction', desc: '10 - 4' },
      { id: 'subtract_level2', name: 'Missing Subtrahend', desc: '8 - ? = 5' },
      { id: 'subtract_level3', name: 'Teens Minus Single', desc: '13 - 4' },
      { id: 'subtract_level4', name: 'Minus Ten', desc: '46 - 10' },
      { id: 'subtract_level5', name: 'Double Minus Single', desc: '63 - 4' },
    ];

    // Default mappings
    const DEFAULT_MAPPINGS = {
      fightWolf: { problemType: 'subtract_level1', questionCount: 3, timerSeconds: 7 },
      fightCultist: { problemType: 'subtract_level2', questionCount: 3, timerSeconds: 7 },
      chop: { problemType: 'add_level3', questionCount: 2, timerSeconds: 0 },
      collectFuel: { problemType: 'add_level1', questionCount: 1, timerSeconds: 0 },
      salvageFan: { problemType: 'add_level2', questionCount: 1, timerSeconds: 0 },
      salvageBolt: { problemType: 'add_level2', questionCount: 1, timerSeconds: 0 },
      salvageRadio: { problemType: 'add_level2', questionCount: 1, timerSeconds: 0 },
      collectKey: { problemType: 'add_level5', questionCount: 3, timerSeconds: 0 },
      crafting: { problemType: 'subtract_level1', questionCount: 1, timerSeconds: 0 },
      harvestFarm: { problemType: 'add_level6', questionCount: 1, timerSeconds: 0 },
      makeStew: { problemType: 'subtract_level3', questionCount: 1, timerSeconds: 0 },
    };

    // Load save data
    function loadSave() {
      try {
        const data = localStorage.getItem(SAVE_KEY);
        if (data) {
          return JSON.parse(data);
        }
      } catch (e) {
        console.error('Failed to load save:', e);
      }
      return null;
    }
    
    // Current game save reference (loaded once on init)
    let gameSave = loadSave() || {};
    
    // Save updated data back to localStorage
    function saveSave(save) {
      try {
        localStorage.setItem(SAVE_KEY, JSON.stringify(save));
        gameSave = save; // Update reference
      } catch (e) {
        console.error('Failed to save:', e);
      }
    }
    
    // ============================================
    // DAILY LOGIN REWARDS
    // ============================================
    
    // Daily reward amounts (7-day cycle)
    const DAILY_REWARDS = [
      { day: 1, diamonds: 5, label: 'Day 1' },
      { day: 2, diamonds: 10, label: 'Day 2' },
      { day: 3, diamonds: 15, label: 'Day 3' },
      { day: 4, diamonds: 20, label: 'Day 4' },
      { day: 5, diamonds: 25, label: 'Day 5' },
      { day: 6, diamonds: 30, label: 'Day 6' },
      { day: 7, diamonds: 50, label: 'Week Bonus!' }
    ];
    
    // Check if player should receive daily reward
    function checkDailyReward() {
      const today = new Date().toISOString().split('T')[0];
      
      // Already claimed today
      if (gameSave.lastRewardClaimed === today) {
        return null;
      }
      
      // Calculate consecutive days
      const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
      let consecutiveDays = gameSave.consecutiveLoginDays || 0;
      
      if (gameSave.lastRewardClaimed === yesterday) {
        // Streak continues
        consecutiveDays++;
      } else if (gameSave.lastRewardClaimed) {
        // Streak broken
        consecutiveDays = 1;
      } else {
        // First time
        consecutiveDays = 1;
      }
      
      // Get reward for current day in cycle (1-7)
      const dayInCycle = ((consecutiveDays - 1) % 7) + 1;
      const reward = DAILY_REWARDS[dayInCycle - 1];
      
      // Check for streak bonus (7+ consecutive days = 1.5x multiplier)
      const streakBonus = consecutiveDays >= 7 ? 1.5 : 1;
      const totalReward = Math.floor(reward.diamonds * streakBonus);
      
      return {
        dayInCycle,
        consecutiveDays,
        baseReward: reward.diamonds,
        streakBonus,
        totalReward,
        label: reward.label
      };
    }
    
    // Claim daily reward
    function claimDailyReward() {
      const reward = checkDailyReward();
      if (!reward) return null;
      
      const today = new Date().toISOString().split('T')[0];
      
      // Update save
      gameSave.lastRewardClaimed = today;
      gameSave.consecutiveLoginDays = reward.consecutiveDays;
      gameSave.totalDiamondsEarned = (gameSave.totalDiamondsEarned || 0) + reward.totalReward;
      
      saveSave(gameSave);
      updateLobbyStats();
      
      return reward;
    }
    
    // Show daily reward popup
    function showDailyRewardPopup() {
      const reward = checkDailyReward();
      if (!reward) return;
      
      const overlay = document.createElement('div');
      overlay.id = 'dailyRewardOverlay';
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
      `;
      
      const popup = document.createElement('div');
      popup.style.cssText = `
        background: linear-gradient(180deg, #1a2332 0%, #0c1420 100%);
        border: 3px solid #fbbf24;
        border-radius: 20px;
        padding: 40px 50px;
        max-width: 500px;
        text-align: center;
        animation: bounceIn 0.5s ease;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 60px rgba(251, 191, 36, 0.3);
      `;
      
      // Build day indicators
      let dayIndicators = '';
      for (let i = 1; i <= 7; i++) {
        const isCurrentDay = i === reward.dayInCycle;
        const isPastDay = i < reward.dayInCycle || (reward.consecutiveDays > 7 && i <= 7);
        const dayReward = DAILY_REWARDS[i - 1];
        
        dayIndicators += `
          <div style="
            display: flex;
            flex-direction: column;
            align-items: center;
            ${isCurrentDay ? 'transform: scale(1.2);' : ''}
          ">
            <div style="
              width: 40px;
              height: 40px;
              border-radius: 50%;
              background: ${isCurrentDay ? 'linear-gradient(135deg, #fbbf24, #f59e0b)' : isPastDay ? '#22c55e' : 'rgba(255,255,255,0.1)'};
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: ${isCurrentDay ? '20px' : '14px'};
              color: ${isCurrentDay || isPastDay ? 'white' : '#666'};
              font-weight: 700;
              border: 2px solid ${isCurrentDay ? '#fbbf24' : isPastDay ? '#22c55e' : 'rgba(255,255,255,0.2)'};
              ${isCurrentDay ? 'box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);' : ''}
            ">${isPastDay && !isCurrentDay ? '‚úì' : i}</div>
            <div style="font-size: 10px; color: #888; margin-top: 4px;">${dayReward.diamonds}üíé</div>
          </div>
        `;
      }
      
      popup.innerHTML = `
        <div style="font-size: 50px; margin-bottom: 15px;">üéÅ</div>
        <div style="font-size: 28px; font-weight: 700; color: #fbbf24; margin-bottom: 10px; font-family: 'Kalam', cursive;">
          Daily Reward!
        </div>
        <div style="font-size: 16px; color: #c4c4c4; margin-bottom: 25px;">
          ${reward.label} - ${reward.consecutiveDays} day${reward.consecutiveDays > 1 ? 's' : ''} streak!
        </div>
        
        <div style="display: flex; justify-content: center; gap: 12px; margin-bottom: 25px;">
          ${dayIndicators}
        </div>
        
        <div style="
          background: rgba(251, 191, 36, 0.15);
          border: 2px solid rgba(251, 191, 36, 0.3);
          border-radius: 16px;
          padding: 20px;
          margin-bottom: 25px;
        ">
          <div style="font-size: 48px; font-weight: 700; color: #fbbf24; font-family: 'Kalam', cursive;">
            +${reward.totalReward} üíé
          </div>
          ${reward.streakBonus > 1 ? `
            <div style="font-size: 14px; color: #22c55e; margin-top: 8px;">
              ‚ú® Week streak bonus: ${Math.round((reward.streakBonus - 1) * 100)}% extra!
            </div>
          ` : ''}
        </div>
        
        <button id="claimDailyRewardBtn" style="
          background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
          border: none;
          color: #000;
          padding: 16px 50px;
          border-radius: 12px;
          font-size: 20px;
          font-weight: 700;
          font-family: 'Kalam', cursive;
          cursor: pointer;
          transition: all 0.2s;
        ">Claim Reward!</button>
        
        <div style="font-size: 12px; color: #666; margin-top: 15px;">
          Come back tomorrow for more rewards!
        </div>
      `;
      
      // Add animation styles
      if (!document.getElementById('daily-reward-style')) {
        const style = document.createElement('style');
        style.id = 'daily-reward-style';
        style.textContent = `
          @keyframes bounceIn {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
          }
          @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
          }
        `;
        document.head.appendChild(style);
      }
      
      overlay.appendChild(popup);
      document.body.appendChild(overlay);
      
      // Claim button handler
      document.getElementById('claimDailyRewardBtn').addEventListener('click', () => {
        claimDailyReward();
        
        // Show confetti effect
        for (let i = 0; i < 30; i++) {
          const confetti = document.createElement('div');
          confetti.style.cssText = `
            position: fixed;
            top: -20px;
            left: ${Math.random() * 100}%;
            width: 10px;
            height: 10px;
            background: ${['#fbbf24', '#22c55e', '#ff5e5e', '#3b82f6', '#a855f7'][Math.floor(Math.random() * 5)]};
            border-radius: 50%;
            animation: confetti ${2 + Math.random() * 2}s linear forwards;
            animation-delay: ${Math.random() * 0.5}s;
            z-index: 2001;
          `;
          document.body.appendChild(confetti);
          setTimeout(() => confetti.remove(), 4000);
        }
        
        // Close popup
        setTimeout(() => {
          overlay.remove();
        }, 500);
      });
    }
    
    // Update daily reward button appearance
    function updateDailyRewardButton() {
      const btn = document.getElementById('dailyRewardButton');
      if (checkDailyReward()) {
        btn.classList.add('has-reward');
        btn.title = 'Claim your daily reward!';
      } else {
        btn.classList.remove('has-reward');
        btn.title = 'Daily rewards (come back tomorrow!)';
      }
    }
    
    // Daily reward button click - show popup or info
    document.getElementById('dailyRewardButton').addEventListener('click', () => {
      if (checkDailyReward()) {
        showDailyRewardPopup();
      } else {
        showDailyRewardInfo();
      }
    });
    
    // Show daily reward info (when already claimed)
    function showDailyRewardInfo() {
      const consecutiveDays = gameSave.consecutiveLoginDays || 0;
      const dayInCycle = consecutiveDays > 0 ? ((consecutiveDays - 1) % 7) + 1 : 0;
      
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
      `;
      
      // Build day indicators
      let dayIndicators = '';
      for (let i = 1; i <= 7; i++) {
        const isPastDay = i <= dayInCycle;
        const dayReward = DAILY_REWARDS[i - 1];
        
        dayIndicators += `
          <div style="
            display: flex;
            flex-direction: column;
            align-items: center;
          ">
            <div style="
              width: 45px;
              height: 45px;
              border-radius: 50%;
              background: ${isPastDay ? '#22c55e' : 'rgba(255,255,255,0.1)'};
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 16px;
              color: ${isPastDay ? 'white' : '#666'};
              font-weight: 700;
              border: 2px solid ${isPastDay ? '#22c55e' : 'rgba(255,255,255,0.2)'};
            ">${isPastDay ? '‚úì' : i}</div>
            <div style="font-size: 11px; color: #888; margin-top: 4px;">${dayReward.diamonds}üíé</div>
            <div style="font-size: 9px; color: #666;">${dayReward.label}</div>
          </div>
        `;
      }
      
      overlay.innerHTML = `
        <div style="
          background: linear-gradient(180deg, #1a2332 0%, #0c1420 100%);
          border: 3px solid #fbbf24;
          border-radius: 20px;
          padding: 30px 40px;
          max-width: 500px;
          text-align: center;
        ">
          <div style="font-size: 40px; margin-bottom: 15px;">üéÅ</div>
          <div style="font-size: 24px; font-weight: 700; color: #fbbf24; margin-bottom: 10px; font-family: 'Kalam', cursive;">
            Daily Rewards
          </div>
          <div style="font-size: 14px; color: #22c55e; margin-bottom: 20px;">
            ‚úì Today's reward claimed!
          </div>
          
          <div style="font-size: 16px; color: #c4c4c4; margin-bottom: 20px;">
            Current streak: <strong>${consecutiveDays}</strong> day${consecutiveDays !== 1 ? 's' : ''}
            ${consecutiveDays >= 7 ? '<span style="color: #fbbf24;"> (1.5x bonus active!)</span>' : ''}
          </div>
          
          <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 25px;">
            ${dayIndicators}
          </div>
          
          <div style="font-size: 13px; color: #888; margin-bottom: 20px;">
            Come back tomorrow for your next reward!
          </div>
          
          <button onclick="this.parentElement.parentElement.remove()" style="
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-family: 'Kalam', cursive;
            cursor: pointer;
          ">Close</button>
        </div>
      `;
      
      document.body.appendChild(overlay);
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) overlay.remove();
      });
    }
    
    // Show daily reward on page load if available
    setTimeout(() => {
      updateDailyRewardButton();
      if (checkDailyReward()) {
        showDailyRewardPopup();
      }
    }, 500);

    // Save data
    function saveSave(save) {
      try {
        localStorage.setItem(SAVE_KEY, JSON.stringify(save));
        return true;
      } catch (e) {
        console.error('Failed to save:', e);
        return false;
      }
    }

    // Get current mappings (from save or defaults)
    function getMappings() {
      const save = loadSave();
      if (save && save.adminConfig && save.adminConfig.mathMappings) {
        return { ...DEFAULT_MAPPINGS, ...save.adminConfig.mathMappings };
      }
      return { ...DEFAULT_MAPPINGS };
    }

    // Save mappings to save file
    function saveMappings(mappings) {
      let save = loadSave();
      if (!save) {
        // Create minimal save structure
        save = {
          version: 1,
          adminConfig: { mathMappings: {} }
        };
      }
      if (!save.adminConfig) {
        save.adminConfig = { mathMappings: {} };
      }
      save.adminConfig.mathMappings = mappings;
      return saveSave(save);
    }

    // Populate the mappings UI
    function populateMappingsUI() {
      const container = document.getElementById('mappingsContainer');
      const mappings = getMappings();
      
      container.innerHTML = GAME_ACTIONS.map(action => {
        const mapping = mappings[action.id] || DEFAULT_MAPPINGS[action.id];
        const hasTimer = action.defaultTimer > 0;
        
        return `
          <div class="mapping-row">
            <div class="mapping-label">${action.name}</div>
            <select class="mapping-select" data-action="${action.id}" data-field="problemType">
              ${PROBLEM_TYPES.map(pt => 
                `<option value="${pt.id}" ${mapping.problemType === pt.id ? 'selected' : ''}>${pt.name}</option>`
              ).join('')}
            </select>
            <input type="number" class="mapping-input" data-action="${action.id}" data-field="questionCount" 
                   value="${mapping.questionCount}" min="1" max="5">
            <input type="number" class="mapping-input" data-action="${action.id}" data-field="timerSeconds" 
                   value="${mapping.timerSeconds}" min="0" max="30" ${!hasTimer ? 'disabled style="opacity: 0.5"' : ''}>
          </div>
        `;
      }).join('');
    }

    // Populate problem types reference
    function populateProblemTypesUI() {
      const grid = document.getElementById('problemTypesGrid');
      
      grid.innerHTML = PROBLEM_TYPES.map(pt => `
        <div class="problem-type-card">
          <div class="problem-type-id">${pt.id}</div>
          <div class="problem-type-name">${pt.name}</div>
          <div class="problem-type-desc">${pt.desc}</div>
        </div>
      `).join('');
    }

    // Get current mappings from UI
    function getMappingsFromUI() {
      const mappings = {};
      
      GAME_ACTIONS.forEach(action => {
        const problemType = document.querySelector(`[data-action="${action.id}"][data-field="problemType"]`).value;
        const questionCount = parseInt(document.querySelector(`[data-action="${action.id}"][data-field="questionCount"]`).value) || 1;
        const timerSeconds = parseInt(document.querySelector(`[data-action="${action.id}"][data-field="timerSeconds"]`).value) || 0;
        
        mappings[action.id] = { problemType, questionCount, timerSeconds };
      });
      
      return mappings;
    }

    // Show save notification
    function showSaveNotification() {
      const notification = document.getElementById('saveNotification');
      notification.classList.add('visible');
      setTimeout(() => {
        notification.classList.remove('visible');
      }, 2000);
    }

    // Admin panel controls
    const adminButton = document.getElementById('adminButton');
    const adminPanel = document.getElementById('adminPanel');
    const adminClose = document.getElementById('adminClose');
    const saveMappingsBtn = document.getElementById('saveMappingsBtn');
    const resetMappingsBtn = document.getElementById('resetMappingsBtn');

    adminButton.addEventListener('click', () => {
      populateMappingsUI();
      populateProblemTypesUI();
      adminPanel.classList.add('active');
    });

    adminClose.addEventListener('click', () => {
      adminPanel.classList.remove('active');
    });

    saveMappingsBtn.addEventListener('click', () => {
      const mappings = getMappingsFromUI();
      if (saveMappings(mappings)) {
        showSaveNotification();
      }
    });

    resetMappingsBtn.addEventListener('click', () => {
      if (confirm('Reset all mappings to defaults?')) {
        saveMappings(DEFAULT_MAPPINGS);
        populateMappingsUI();
        showSaveNotification();
      }
    });

    // Close panel with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && adminPanel.classList.contains('active')) {
        adminPanel.classList.remove('active');
      }
      if (e.key === 'Escape' && shopPanel.classList.contains('active')) {
        shopPanel.classList.remove('active');
      }
    });

    // ============================================
    // CLASS SHOP
    // ============================================

    // Class definitions
    const CLASSES = [
      { id: 'thick_skin', name: 'Thick Skin', icon: 'üõ°Ô∏è', cost: 10, levelRequired: 1, 
        effect: '-10% wolf damage', description: 'Wolves deal less damage to you' },
      { id: 'lucky_axe', name: 'Lucky Axe', icon: 'üçÄ', cost: 15, levelRequired: 1,
        effect: '20% chance bonus wood', description: 'Sometimes get extra wood from trees' },
      { id: 'quick_thinker', name: 'Quick Thinker', icon: '‚ö°', cost: 20, levelRequired: 2,
        effect: '+2 seconds on timers', description: 'More time to answer timed questions' },
      { id: 'sharp_memory', name: 'Sharp Memory', icon: 'üß†', cost: 25, levelRequired: 3,
        effect: 'Hint after wrong answer', description: 'Get a helpful hint when you make a mistake' },
      { id: 'iron_stomach', name: 'Iron Stomach', icon: 'üçñ', cost: 15, levelRequired: 2,
        effect: 'Food heals +25% more', description: 'Get more health from eating' },
      { id: 'fire_master', name: 'Fire Master', icon: 'üî•', cost: 20, levelRequired: 2,
        effect: 'Campfire burns 20% longer', description: 'Fire drains slower' },
      { id: 'eagle_eye', name: 'Eagle Eye', icon: 'ü¶Ö', cost: 30, levelRequired: 4,
        effect: 'See wolves from further', description: 'Spot wolves at greater distance' },
      { id: 'math_prodigy', name: 'Math Prodigy', icon: 'üéì', cost: 50, levelRequired: 5,
        effect: '+50% XP from questions', description: 'Earn more XP from correct answers' },
      { id: 'pet_whisperer', name: 'Pet Whisperer', icon: 'üê±', cost: 25, levelRequired: 3,
        effect: 'Pet abilities +25%', description: 'Your pet becomes more effective' },
      { id: 'night_walker', name: 'Night Walker', icon: 'üåô', cost: 40, levelRequired: 4,
        effect: 'Move 10% faster at night', description: 'Move quicker during dangerous nights' },
    ];

    // Get available diamonds (total earned minus spent)
    function getAvailableDiamonds() {
      const save = loadSave();
      if (!save) return 0;
      const earned = save.totalDiamondsEarned || 0;
      const spent = save.diamondsSpent || 0;
      return earned - spent;
    }

    // Get player level
    function getPlayerLevel() {
      const save = loadSave();
      if (!save) return 1;
      return save.playerLevel || 1;
    }

    // Check if a class is owned
    function isClassOwned(classId) {
      const save = loadSave();
      if (!save || !save.classes) return false;
      return save.classes[classId]?.purchased === true;
    }

    // Purchase a class
    function purchaseClass(classId) {
      const classData = CLASSES.find(c => c.id === classId);
      if (!classData) return false;

      const available = getAvailableDiamonds();
      const level = getPlayerLevel();

      if (available < classData.cost) return false;
      if (level < classData.levelRequired) return false;
      if (isClassOwned(classId)) return false;

      let save = loadSave();
      if (!save) {
        save = { version: 1, classes: {}, diamondsSpent: 0 };
      }
      if (!save.classes) save.classes = {};
      if (!save.diamondsSpent) save.diamondsSpent = 0;

      save.classes[classId] = { 
        purchased: true, 
        purchaseDate: new Date().toISOString() 
      };
      save.diamondsSpent += classData.cost;

      saveSave(save);
      return true;
    }

    // Update lobby stats display
    function updateLobbyStats() {
      const diamondCount = document.getElementById('diamondCount');
      const playerLevel = document.getElementById('playerLevel');
      
      if (diamondCount) {
        diamondCount.textContent = getAvailableDiamonds();
      }
      if (playerLevel) {
        playerLevel.textContent = getPlayerLevel();
      }
    }

    // Populate shop grid
    function populateShopGrid() {
      const grid = document.getElementById('classesGrid');
      const shopDiamonds = document.getElementById('shopDiamondCount');
      const available = getAvailableDiamonds();
      const level = getPlayerLevel();

      if (shopDiamonds) {
        shopDiamonds.textContent = available;
      }

      grid.innerHTML = CLASSES.map(cls => {
        const owned = isClassOwned(cls.id);
        const canAfford = available >= cls.cost;
        const meetsLevel = level >= cls.levelRequired;
        const canBuy = !owned && canAfford && meetsLevel;

        let statusClass = '';
        let buttonText = '';
        
        if (owned) {
          statusClass = 'owned';
          buttonText = '‚úì Owned';
        } else if (!meetsLevel) {
          statusClass = 'locked';
          buttonText = `üîí Level ${cls.levelRequired}`;
        } else if (!canAfford) {
          statusClass = '';
          buttonText = `Need ${cls.cost - available} more üíé`;
        } else {
          buttonText = `Buy for ${cls.cost} üíé`;
        }

        return `
          <div class="class-card ${statusClass}">
            <div class="class-card-header">
              <span class="class-icon">${cls.icon}</span>
              <span class="class-cost">${owned ? '‚úì' : cls.cost + ' üíé'}</span>
            </div>
            <div class="class-name">${cls.name}</div>
            <div class="class-effect">${cls.effect}</div>
            <div class="class-requirement">Requires Level ${cls.levelRequired}</div>
            <button class="class-buy-btn" 
                    data-class-id="${cls.id}" 
                    ${!canBuy ? 'disabled' : ''}>
              ${buttonText}
            </button>
          </div>
        `;
      }).join('');

      // Add click handlers
      grid.querySelectorAll('.class-buy-btn:not(:disabled)').forEach(btn => {
        btn.addEventListener('click', () => {
          const classId = btn.dataset.classId;
          const classData = CLASSES.find(c => c.id === classId);
          
          if (purchaseClass(classId)) {
            showPurchaseNotification(classData.name, classData.icon);
            populateShopGrid();
            updateLobbyStats();
          }
        });
      });
    }

    // Show purchase notification
    function showPurchaseNotification(className, icon) {
      const notification = document.createElement('div');
      notification.className = 'purchase-notification';
      notification.innerHTML = `${icon} ${className} Unlocked!`;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.3s';
        setTimeout(() => notification.remove(), 300);
      }, 2000);
    }

    // Shop panel controls
    const shopButton = document.getElementById('shopButton');
    const shopPanel = document.getElementById('shopPanel');
    const shopClose = document.getElementById('shopClose');

    shopButton.addEventListener('click', () => {
      populateShopGrid();
      shopPanel.classList.add('active');
    });

    shopClose.addEventListener('click', () => {
      shopPanel.classList.remove('active');
    });

    // ============================================
    // ACHIEVEMENT SYSTEM
    // ============================================
    
    // Achievement definitions (mirror of game.html)
    const ACHIEVEMENTS = {
      // Math Master - Questions Answered
      math_first_steps: {
        id: 'math_first_steps',
        name: 'First Steps',
        description: 'Answer 10 questions correctly',
        icon: 'üìù',
        category: 'Math Master',
        stat: 'totalQuestionsCorrect',
        target: 10,
        reward: 5
      },
      math_century: {
        id: 'math_century',
        name: 'Century Club',
        description: 'Answer 100 questions correctly',
        icon: 'üíØ',
        category: 'Math Master',
        stat: 'totalQuestionsCorrect',
        target: 100,
        reward: 15
      },
      math_machine: {
        id: 'math_machine',
        name: 'Math Machine',
        description: 'Answer 500 questions correctly',
        icon: 'ü§ñ',
        category: 'Math Master',
        stat: 'totalQuestionsCorrect',
        target: 500,
        reward: 30
      },
      math_legend: {
        id: 'math_legend',
        name: 'Math Legend',
        description: 'Answer 1000 questions correctly',
        icon: 'üèÜ',
        category: 'Math Master',
        stat: 'totalQuestionsCorrect',
        target: 1000,
        reward: 50
      },
      
      // Streak Star
      streak_fire: {
        id: 'streak_fire',
        name: 'On Fire',
        description: 'Reach a 10 streak',
        icon: 'üî•',
        category: 'Streak Star',
        stat: 'bestStreak',
        target: 10,
        reward: 10
      },
      streak_unstoppable: {
        id: 'streak_unstoppable',
        name: 'Unstoppable',
        description: 'Reach a 25 streak',
        icon: '‚ö°',
        category: 'Streak Star',
        stat: 'bestStreak',
        target: 25,
        reward: 20
      },
      streak_perfect: {
        id: 'streak_perfect',
        name: 'Perfect Mind',
        description: 'Reach a 50 streak',
        icon: 'üß†',
        category: 'Streak Star',
        stat: 'bestStreak',
        target: 50,
        reward: 35
      },
      streak_legendary: {
        id: 'streak_legendary',
        name: 'Legendary',
        description: 'Reach a 100 streak',
        icon: 'üëë',
        category: 'Streak Star',
        stat: 'bestStreak',
        target: 100,
        reward: 75
      },
      
      // Survivor
      survivor_first: {
        id: 'survivor_first',
        name: 'First Dawn',
        description: 'Survive your first night',
        icon: 'üåÖ',
        category: 'Survivor',
        stat: 'totalNightsSurvived',
        target: 1,
        reward: 5
      },
      survivor_week: {
        id: 'survivor_week',
        name: 'Week Warrior',
        description: 'Survive 7 nights total',
        icon: 'üìÖ',
        category: 'Survivor',
        stat: 'totalNightsSurvived',
        target: 7,
        reward: 15
      },
      survivor_master: {
        id: 'survivor_master',
        name: 'Night Master',
        description: 'Survive 25 nights total',
        icon: 'üåô',
        category: 'Survivor',
        stat: 'totalNightsSurvived',
        target: 25,
        reward: 30
      },
      survivor_eternal: {
        id: 'survivor_eternal',
        name: 'Eternal Survivor',
        description: 'Survive 50 nights total',
        icon: '‚≠ê',
        category: 'Survivor',
        stat: 'totalNightsSurvived',
        target: 50,
        reward: 50
      },
      
      // Speed Demon
      speed_quick: {
        id: 'speed_quick',
        name: 'Quick Draw',
        description: 'Answer 10 questions under 3 seconds',
        icon: '‚è±Ô∏è',
        category: 'Speed Demon',
        stat: 'fastAnswers3sec',
        target: 10,
        reward: 10
      },
      speed_lightning: {
        id: 'speed_lightning',
        name: 'Lightning Fast',
        description: 'Answer 50 questions under 2 seconds',
        icon: '‚ö°',
        category: 'Speed Demon',
        stat: 'fastAnswers2sec',
        target: 50,
        reward: 25
      },
      
      // Hunter
      hunter_wolf: {
        id: 'hunter_wolf',
        name: 'Wolf Slayer',
        description: 'Defeat 10 wolves',
        icon: 'üê∫',
        category: 'Hunter',
        stat: 'totalWolvesDefeated',
        target: 10,
        reward: 10
      },
      hunter_pack: {
        id: 'hunter_pack',
        name: 'Pack Leader',
        description: 'Defeat 50 wolves',
        icon: 'üêæ',
        category: 'Hunter',
        stat: 'totalWolvesDefeated',
        target: 50,
        reward: 25
      },
      hunter_cult: {
        id: 'hunter_cult',
        name: 'Cult Crusher',
        description: 'Defeat 25 cultists',
        icon: 'üë§',
        category: 'Hunter',
        stat: 'totalCultistsDefeated',
        target: 25,
        reward: 20
      },
      
      // Collector
      collector_lucky: {
        id: 'collector_lucky',
        name: 'Lucky Find',
        description: 'Find your first rare item',
        icon: 'üçÄ',
        category: 'Collector',
        stat: 'totalRareItemsFound',
        target: 1,
        reward: 5
      },
      collector_treasure: {
        id: 'collector_treasure',
        name: 'Treasure Hunter',
        description: 'Find 10 rare items',
        icon: 'üíé',
        category: 'Collector',
        stat: 'totalRareItemsFound',
        target: 10,
        reward: 20
      },
      
      // Lumberjack
      lumber_chopper: {
        id: 'lumber_chopper',
        name: 'Tree Chopper',
        description: 'Chop 25 trees',
        icon: 'ü™ì',
        category: 'Lumberjack',
        stat: 'totalTreesChopped',
        target: 25,
        reward: 10
      },
      lumber_deforest: {
        id: 'lumber_deforest',
        name: 'Deforestation',
        description: 'Chop 100 trees',
        icon: 'üå≤',
        category: 'Lumberjack',
        stat: 'totalTreesChopped',
        target: 100,
        reward: 25
      }
    };
    
    // ============================================
    // PET PANEL
    // ============================================
    
    // Pet type definitions (mirror of game.html)
    const PET_TYPES = {
      cat: {
        type: 'cat',
        name: 'Cat',
        icon: 'üê±',
        description: 'A loyal feline companion',
        abilities: ['Wolf Alert', '+10% Rare Items'],
        abilityDesc: 'Alerts you when wolves are nearby and increases rare item drops'
      },
      pig: {
        type: 'pig',
        name: 'Pig',
        icon: 'üê∑',
        description: 'A friendly farm friend',
        abilities: ['Find Carrots', '+1 Harvest Bonus'],
        abilityDesc: 'Occasionally finds buried carrots and increases farm harvests'
      },
      bee: {
        type: 'bee',
        name: 'Bee',
        icon: 'üêù',
        description: 'A buzzing helper bee',
        abilities: ['Produce Honey', 'Faster Farm'],
        abilityDesc: 'Produces healing honey over time and speeds up crop growth'
      }
    };
    
    // Pet panel controls
    const petButton = document.getElementById('petButton');
    const petPanel = document.getElementById('petPanel');
    const petClose = document.getElementById('petClose');
    
    petButton.addEventListener('click', () => {
      populatePetPanel();
      petPanel.classList.add('active');
    });
    
    petClose.addEventListener('click', () => {
      petPanel.classList.remove('active');
    });
    
    // Update pet button appearance
    function updatePetButton() {
      if (!gameSave.pet) {
        petButton.classList.add('no-pet');
        petButton.title = 'No pet yet (Level 2 required)';
      } else {
        petButton.classList.remove('no-pet');
        petButton.textContent = PET_TYPES[gameSave.pet.type].icon;
        petButton.title = `Your pet: ${gameSave.pet.name}`;
      }
    }
    
    // Get pet happiness status
    function getPetHappinessStatus(happiness) {
      if (happiness >= 80) return { text: 'Very Happy', color: '#22c55e', emoji: 'üòä' };
      if (happiness >= 50) return { text: 'Content', color: '#f59e0b', emoji: 'üòê' };
      if (happiness >= 30) return { text: 'Hungry', color: '#ff9500', emoji: 'üòü' };
      return { text: 'Very Hungry', color: '#ff5e5e', emoji: 'üò¢' };
    }
    
    // Populate pet panel
    function populatePetPanel() {
      const container = document.getElementById('petPanelContent');
      
      if (!gameSave.pet) {
        const level = getPlayerLevel();
        container.innerHTML = `
          <div class="no-pet-message">
            <div class="no-pet-icon">üêæ</div>
            <div class="no-pet-title">No Pet Yet</div>
            <div class="no-pet-desc">
              ${level < 2 ? 
                'Reach <strong>Level 2</strong> to unlock pet encounters!' :
                'Explore the forest during daytime to find a pet!<br>You might encounter a cat, pig, or bee waiting to be befriended.'
              }
            </div>
          </div>
        `;
        return;
      }
      
      const pet = gameSave.pet;
      const petType = PET_TYPES[pet.type];
      const status = getPetHappinessStatus(pet.happiness);
      const abilitiesActive = pet.happiness >= 30;
      const adoptedDate = new Date(pet.adoptedDate).toLocaleDateString();
      
      let happinessClass = '';
      if (pet.happiness < 30) happinessClass = 'very-hungry';
      else if (pet.happiness < 50) happinessClass = 'hungry';
      
      container.innerHTML = `
        <div class="pet-card-large">
          <div class="pet-card-icon-large">${petType.icon}</div>
          <div class="pet-card-name-large">${pet.name}</div>
          <div class="pet-card-type">${petType.name}</div>
        </div>
        
        <div class="pet-happiness-section">
          <div class="pet-happiness-label">
            <span>Happiness</span>
            <span style="color: ${status.color}">${status.text} ${status.emoji}</span>
          </div>
          <div class="pet-happiness-bar-large">
            <div class="pet-happiness-fill-large ${happinessClass}" style="width: ${pet.happiness}%"></div>
          </div>
          <div style="font-size: 12px; color: var(--text-muted);">
            Feed your pet carrots to keep them happy!
          </div>
        </div>
        
        <div class="pet-abilities-section">
          <div class="pet-abilities-title">Abilities ${abilitiesActive ? '(Active)' : '(Inactive - Pet too hungry!)'}</div>
          ${petType.abilities.map(ability => `
            <div class="pet-ability-item ${abilitiesActive ? 'pet-ability-active' : 'pet-ability-inactive'}">
              ${abilitiesActive ? '‚úì' : '‚úó'} ${ability}
            </div>
          `).join('')}
        </div>
        
        <div class="pet-stats-grid">
          <div class="pet-stat-item">
            <div class="pet-stat-value">${pet.level}</div>
            <div class="pet-stat-label">Level</div>
          </div>
          <div class="pet-stat-item">
            <div class="pet-stat-value">${pet.totalCarrotsFed || 0}</div>
            <div class="pet-stat-label">Carrots Fed</div>
          </div>
          <div class="pet-stat-item">
            <div class="pet-stat-value">${adoptedDate}</div>
            <div class="pet-stat-label">Adopted</div>
          </div>
          <div class="pet-stat-item">
            <div class="pet-stat-value">${pet.happiness}%</div>
            <div class="pet-stat-label">Happiness</div>
          </div>
        </div>
        
        <div class="pet-feed-section">
          <span style="font-size: 40px;">ü•ï</span>
          <div>
            <div style="font-size: 14px; color: var(--text-muted);">Feed your pet during gameplay!</div>
            <div style="font-size: 12px; color: var(--text-muted); margin-top: 5px;">
              Each carrot restores +25 happiness
            </div>
          </div>
        </div>
      `;
    }
    
    // Update pet button on load
    updatePetButton();

    // Achievement panel controls
    const achievementButton = document.getElementById('achievementButton');
    const achievementPanel = document.getElementById('achievementPanel');
    const achievementClose = document.getElementById('achievementClose');
    
    achievementButton.addEventListener('click', () => {
      populateAchievementGallery();
      achievementPanel.classList.add('active');
    });
    
    achievementClose.addEventListener('click', () => {
      achievementPanel.classList.remove('active');
    });
    
    // Get achievement progress
    function getAchievementProgress(achievement, stats) {
      const current = stats[achievement.stat] || 0;
      const percent = Math.min(100, (current / achievement.target) * 100);
      return { current, target: achievement.target, percent };
    }
    
    // Get achievements grouped by category
    function getAchievementsByCategory(earnedList, stats) {
      const categories = {};
      
      Object.values(ACHIEVEMENTS).forEach(achievement => {
        if (!categories[achievement.category]) {
          categories[achievement.category] = [];
        }
        categories[achievement.category].push({
          ...achievement,
          earned: earnedList.includes(achievement.id),
          progress: getAchievementProgress(achievement, stats)
        });
      });
      
      return categories;
    }
    
    // Populate achievement gallery
    function populateAchievementGallery() {
      const gallery = document.getElementById('achievementGallery');
      const earnedList = gameSave.achievements || [];
      const stats = gameSave.stats || {};
      
      // Calculate totals
      const totalAchievements = Object.keys(ACHIEVEMENTS).length;
      const earnedCount = earnedList.length;
      const totalDiamondsEarned = earnedList.reduce((sum, id) => {
        return sum + (ACHIEVEMENTS[id]?.reward || 0);
      }, 0);
      
      // Update header stats
      document.getElementById('achievementEarnedCount').textContent = earnedCount;
      document.getElementById('achievementTotalCount').textContent = totalAchievements;
      document.getElementById('achievementDiamonds').textContent = totalDiamondsEarned + 'üíé';
      
      const categories = getAchievementsByCategory(earnedList, stats);
      
      let html = '';
      
      Object.entries(categories).forEach(([categoryName, achievements]) => {
        const categoryEarned = achievements.filter(a => a.earned).length;
        
        html += `
          <div class="achievement-category">
            <div class="achievement-category-header">
              <div class="achievement-category-name">${categoryName}</div>
              <div class="achievement-category-count">${categoryEarned} / ${achievements.length}</div>
            </div>
            <div class="achievement-grid">
        `;
        
        achievements.forEach(achievement => {
          const statusClass = achievement.earned ? 'earned' : 'locked';
          const progressPercent = achievement.earned ? 100 : achievement.progress.percent;
          
          html += `
            <div class="achievement-card ${statusClass}">
              <div class="achievement-card-icon">${achievement.icon}</div>
              <div class="achievement-card-info">
                <div class="achievement-card-name">${achievement.name}</div>
                <div class="achievement-card-desc">${achievement.description}</div>
                ${achievement.earned ? 
                  `<div class="achievement-card-status">‚úì Earned!</div>
                   <div class="achievement-card-reward">+${achievement.reward}üíé</div>` :
                  `<div class="achievement-card-progress">
                    <div class="achievement-card-progress-fill" style="width: ${progressPercent}%"></div>
                  </div>
                  <div class="achievement-card-status">${achievement.progress.current} / ${achievement.target}</div>`
                }
              </div>
            </div>
          `;
        });
        
        html += `
            </div>
          </div>
        `;
      });
      
      gallery.innerHTML = html;
    }

    // Initialize lobby stats on load
    updateLobbyStats();

    // ============================================
    // QUEST SYSTEM
    // ============================================

    // Quest definitions
    const QUEST_TEMPLATES = [
      // Easy quests
      { id: 'chop_5', name: 'Lumberjack', icon: 'ü™ì', description: 'Chop 5 trees', target: 5, stat: 'treesChopped', reward: 5 },
      { id: 'wolves_2', name: 'Wolf Hunter', icon: 'üê∫', description: 'Defeat 2 wolves', target: 2, stat: 'wolvesDefeated', reward: 10 },
      { id: 'questions_10', name: 'Quick Learner', icon: 'üìù', description: 'Answer 10 questions correctly', target: 10, stat: 'questionsCorrect', reward: 5 },
      { id: 'streak_5', name: 'On Fire', icon: 'üî•', description: 'Get a 5-streak', target: 5, stat: 'bestStreak', reward: 8 },
      { id: 'survive_night', name: 'Survivor', icon: 'üåô', description: 'Survive 1 night', target: 1, stat: 'nightsSurvived', reward: 5 },
      // Medium quests
      { id: 'chop_15', name: 'Master Lumberjack', icon: 'ü™ì', description: 'Chop 15 trees', target: 15, stat: 'treesChopped', reward: 15 },
      { id: 'wolves_5', name: 'Wolf Slayer', icon: 'üê∫', description: 'Defeat 5 wolves', target: 5, stat: 'wolvesDefeated', reward: 25 },
      { id: 'questions_25', name: 'Math Whiz', icon: 'üìù', description: 'Answer 25 questions correctly', target: 25, stat: 'questionsCorrect', reward: 15 },
      { id: 'streak_10', name: 'Unstoppable', icon: 'üî•', description: 'Get a 10-streak', target: 10, stat: 'bestStreak', reward: 20 },
      { id: 'night_3', name: 'Night Owl', icon: 'üåô', description: 'Survive 3 nights', target: 3, stat: 'nightsSurvived', reward: 15 },
      { id: 'cultists', name: 'Cult Buster', icon: 'üë§', description: 'Defeat all cultists', target: 3, stat: 'cultistsDefeated', reward: 15 },
      // Hard quests  
      { id: 'rare_item', name: 'Treasure Hunter', icon: '‚ú®', description: 'Find a rare item', target: 1, stat: 'rareItemsFound', reward: 20 },
      { id: 'no_damage', name: 'Untouchable', icon: 'üõ°Ô∏è', description: 'Survive a night without damage', target: 1, stat: 'perfectNights', reward: 25 },
    ];

    // Get today's date string
    function getTodayString() {
      return new Date().toISOString().split('T')[0];
    }

    // Generate random quests for the day
    function generateDailyQuests() {
      const shuffled = [...QUEST_TEMPLATES].sort(() => Math.random() - 0.5);
      return shuffled.slice(0, 3).map(template => ({
        ...template,
        progress: 0,
        completed: false,
        claimed: false
      }));
    }

    // Get current quests from save
    function getQuests() {
      const save = loadSave();
      if (!save) return { quests: [], lastRefresh: null };
      
      const today = getTodayString();
      
      // Check if we need new quests (new day or no quests)
      if (!save.dailyQuests || save.dailyQuests.length === 0 || save.lastQuestRefresh !== today) {
        // Generate new quests
        const newQuests = generateDailyQuests();
        save.dailyQuests = newQuests;
        save.lastQuestRefresh = today;
        // Reset session stats for quest tracking
        save.sessionStats = {
          treesChopped: 0,
          wolvesDefeated: 0,
          questionsCorrect: 0,
          bestStreak: 0,
          nightsSurvived: 0,
          cultistsDefeated: 0,
          rareItemsFound: 0,
          perfectNights: 0
        };
        saveSave(save);
      }
      
      return {
        quests: save.dailyQuests,
        lastRefresh: save.lastQuestRefresh,
        sessionStats: save.sessionStats || {}
      };
    }

    // Update quest progress
    function updateQuestProgress(stat, value) {
      const save = loadSave();
      if (!save || !save.dailyQuests) return;
      
      // Update session stat
      if (!save.sessionStats) save.sessionStats = {};
      save.sessionStats[stat] = Math.max(save.sessionStats[stat] || 0, value);
      
      // Check quest completion
      save.dailyQuests.forEach(quest => {
        if (quest.stat === stat && !quest.completed) {
          quest.progress = Math.min(value, quest.target);
          if (quest.progress >= quest.target) {
            quest.completed = true;
          }
        }
      });
      
      saveSave(save);
    }

    // Claim quest reward
    function claimQuestReward(questId) {
      const save = loadSave();
      if (!save || !save.dailyQuests) return false;
      
      const quest = save.dailyQuests.find(q => q.id === questId);
      if (!quest || !quest.completed || quest.claimed) return false;
      
      quest.claimed = true;
      save.totalDiamondsEarned = (save.totalDiamondsEarned || 0) + quest.reward;
      saveSave(save);
      
      return quest.reward;
    }

    // Force refresh quests (costs diamonds?)
    function refreshQuests() {
      const save = loadSave();
      if (!save) return false;
      
      const newQuests = generateDailyQuests();
      save.dailyQuests = newQuests;
      save.lastQuestRefresh = getTodayString();
      save.sessionStats = {
        treesChopped: 0,
        wolvesDefeated: 0,
        questionsCorrect: 0,
        bestStreak: 0,
        nightsSurvived: 0,
        cultistsDefeated: 0,
        rareItemsFound: 0,
        perfectNights: 0
      };
      saveSave(save);
      
      return true;
    }

    // Populate quests UI
    function populateQuestsGrid() {
      const grid = document.getElementById('questsGrid');
      const refreshInfo = document.getElementById('questRefreshInfo');
      const { quests, sessionStats } = getQuests();

      if (quests.length === 0) {
        grid.innerHTML = '<div class="no-quests">No quests available. Click refresh to get new quests!</div>';
        return;
      }

      refreshInfo.textContent = `Complete quests to earn diamonds! Quests refresh daily.`;

      grid.innerHTML = quests.map(quest => {
        const progress = sessionStats[quest.stat] || 0;
        const displayProgress = Math.min(progress, quest.target);
        const percentage = (displayProgress / quest.target) * 100;
        const isComplete = displayProgress >= quest.target;
        const isClaimed = quest.claimed;

        return `
          <div class="quest-card ${isComplete ? 'completed' : ''}">
            <div class="quest-icon">${quest.icon}</div>
            <div class="quest-info">
              <div class="quest-name">${quest.name}</div>
              <div class="quest-progress-bar">
                <div class="quest-progress-fill" style="width: ${percentage}%"></div>
              </div>
              <div class="quest-progress-text">${quest.description} (${displayProgress}/${quest.target})</div>
            </div>
            <div class="quest-reward">
              <div class="quest-reward-amount">${isClaimed ? '‚úì' : quest.reward + ' üíé'}</div>
              <div class="quest-reward-label">${isClaimed ? 'Claimed' : (isComplete ? 'Click to claim!' : 'Reward')}</div>
              ${isComplete && !isClaimed ? `<button class="claim-btn" data-quest-id="${quest.id}" style="margin-top: 5px; padding: 5px 15px; background: #22c55e; border: none; border-radius: 5px; color: white; cursor: pointer;">Claim</button>` : ''}
            </div>
          </div>
        `;
      }).join('');

      // Add claim handlers
      grid.querySelectorAll('.claim-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const questId = btn.dataset.questId;
          const reward = claimQuestReward(questId);
          if (reward) {
            showPurchaseNotification(`+${reward} Diamonds`, 'üíé');
            populateQuestsGrid();
            updateLobbyStats();
          }
        });
      });
    }

    // Quest panel controls
    const questButton = document.getElementById('questButton');
    const questPanel = document.getElementById('questPanel');
    const questClose = document.getElementById('questClose');
    const refreshQuestsBtn = document.getElementById('refreshQuestsBtn');

    questButton.addEventListener('click', () => {
      populateQuestsGrid();
      questPanel.classList.add('active');
    });

    questClose.addEventListener('click', () => {
      questPanel.classList.remove('active');
    });

    refreshQuestsBtn.addEventListener('click', () => {
      if (confirm('Spin for new quests? This will replace your current quests.')) {
        refreshQuests();
        populateQuestsGrid();
      }
    });

    // Close quest panel with Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && questPanel.classList.contains('active')) {
        questPanel.classList.remove('active');
      }
    });
  </script>
</body>
</html>

